---
import BaseLayout from "../layouts/BaseLayout.astro";

interface Props {
  title: string;
  description?: string;
  pubDate?: string | Date;
  updatedDate?: string | Date;
  heroImage?: string;
  heroCaption?: string;
  tags?: string[] | string;
  keywords?: string[];
  seoTitle?: string;
}

const {
  title,
  description = "",
  pubDate,
  updatedDate,
  heroImage,
  heroCaption = "",
  tags = [],
  keywords = [],
  seoTitle
} = Astro.props as Props;

// normalize dates
const dPub = pubDate ? new Date(pubDate) : null;
const dUpd = updatedDate ? new Date(updatedDate) : null;
const isoPub = dPub && !isNaN(+dPub) ? dPub.toISOString() : "";
const isoUpd = dUpd && !isNaN(+dUpd) ? dUpd.toISOString() : "";
const displayPub = dPub && !isNaN(+dPub)
  ? dPub.toLocaleDateString("en-US", { year:"numeric", month:"long", day:"numeric" })
  : "";
const displayUpd = dUpd && !isNaN(+dUpd)
  ? dUpd.toLocaleDateString("en-US", { year:"numeric", month:"long", day:"numeric" })
  : "";

// normalize tags
const tagList = Array.isArray(tags)
  ? tags
  : typeof tags === "string"
    ? tags.split(",").map(s => s.trim()).filter(Boolean)
    : [];
---

<BaseLayout pageTitle={seoTitle ?? title} description={description}>
  <main class="page-shell">
    <article class="post-card">
      <header class="post-header">
        <h1 class="post-title">{title}</h1>
        <div class="post-author">By WR Selvig</div>
        <div class="post-meta">
          {displayPub && <time datetime={isoPub} title="Published">{displayPub}</time>}
          {displayUpd && displayUpd !== displayPub && (
            <>
              <span class="sep">•</span>
              <time datetime={isoUpd} title="Updated">{displayUpd}</time>
            </>
          )}
        </div>

        {tagList.length > 0 && (
          <ul class="post-tags">
            {tagList.map(t => <li class="tag" key={t}>{t}</li>)}
          </ul>
        )}

        {heroImage && (
          <figure class="post-hero">
            <img
              src={typeof heroImage === "string" ? heroImage : heroImage.src}
              alt={title}
              loading="eager"
            />
            {heroCaption && <figcaption>{heroCaption}</figcaption>}
          </figure>
        )}
      </header>

      <div class="post-body prose">
        <slot /> {/* MDX content renders here */}
      </div>
      <!-- Subscribe block -->
<section class="subscribe-box" aria-labelledby="subTitle">
  <h2 id="subTitle">Get new posts by email</h2>
  <p class="sub-copy">No spam. Unsubscribe anytime.</p>

  <form
    action="https://buttondown.email/api/emails/subscribe"
    method="post"
    target="popupwindow"
    onsubmit={`window.open('https://buttondown.email/REPLACE_WITH_USERNAME', 'popupwindow')`}
    class="embeddable-buttondown-form"
  >
    <input type="email" name="email" required placeholder="you@example.com" aria-label="Email address" />
    <input type="hidden" name="username" value="REPLACE_WITH_USERNAME" />
    <input type="hidden" name="embed" value="1" />
    <button type="submit">Subscribe</button>
  </form>

  <small class="sub-legal">
    Powered by Buttondown • <a href="https://buttondown.email" target="_blank" rel="noreferrer">Learn more</a>
  </small>
</section>

    </article>
  </main>

  <style>
    :root{
      --reading-width: 72ch;
      --side-bleed: min(96px, 8vw);
      --base-font: 18px;
      --lh: 1.7;
      --ink: #111;
      --muted: #6a6a6d;
    }

    .page-shell{
      max-width: 1200px;
      margin: 0 auto;
      padding: clamp(16px, 2vw, 24px);
    }

    .post-card{
      max-width: calc(var(--reading-width) + (2 * var(--side-bleed)));
      margin: clamp(16px, 2vw, 24px) auto 6rem auto;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.16);
      overflow: hidden;
    }

    .post-header{
      max-width: calc(var(--reading-width) + (2 * var(--side-bleed)));
      padding: clamp(18px, 2.2vw, 28px);
      margin: 0 auto;
    }

    .post-title{ margin: 0 0 .35rem; line-height: 1.1; }
    .post-author{
      font-size: 1rem;
      font-weight: 500;
      color: #444;
      margin-bottom: 0.25rem;
    }
    .post-meta{
      font-size: .95rem;
      color: var(--muted);
      display: flex; gap: .5rem; align-items: center; flex-wrap: wrap;
      margin-bottom: .4rem;
    }
    .post-tags{
      list-style: none; display: flex; gap: .4rem; padding: 0; margin: .5rem 0 0;
      flex-wrap: wrap;
    }
    .post-tags .tag{
      font-size: .78rem; color: #2d3a62; background: #eef2ff; border: 1px solid #dde4ff;
      padding: .22rem .5rem; border-radius: 999px; white-space: nowrap;
    }

    .post-hero{ margin: 1rem 0 1.25rem; }
    .post-hero img{
      width: 100%; height: auto; display: block; border-radius: 10px;
    }
    .post-hero figcaption{
      font-size: .9rem; color: var(--muted); margin-top: .4rem; text-align: center;
    }

    .post-body{
      max-width: var(--reading-width);
      margin: 0 auto;
      padding: 0 clamp(18px, 2.2vw, 28px) clamp(22px, 2.4vw, 34px);
      font-size: clamp(17px, 0.35vw + 16px, var(--base-font));
      line-height: var(--lh);
      color: var(--ink);
    }

    .post-body p{ margin: 0 0 1.05em; }
    .post-body h2, .post-body h3, .post-body h4{
      line-height: 1.25;
      margin: 1.9rem 0 .75rem;
      letter-spacing: -0.01em;
    }
    .post-body h1{ font-size: clamp(2rem, 2.1vw + 1.4rem, 2.6rem); margin: 0 0 .5rem; }
    .post-body h2{ font-size: clamp(1.6rem, 1.4vw + 1.1rem, 2rem); }
    .post-body h3{ font-size: clamp(1.25rem, .9vw + 1rem, 1.5rem); }
    .post-body h4{ font-size: clamp(1.1rem, .6vw + .9rem, 1.25rem); }

    .post-body ul, .post-body ol{ padding-left: 1.25rem; margin: 0 0 1.05em; }
    .post-body li{ margin: .25em 0; }

    .post-body blockquote{
      margin: 1.25em 0;
      padding: .75em 1em;
      border-left: 4px solid rgba(0,0,0,.08);
      background: rgba(0,0,0,.03);
      border-radius: 8px;
    }

    .post-body img{
      max-width: 100%; height: auto; border-radius: 10px; margin: 1rem 0;
    }
    .post-body hr{ border: 0; height: 1px; background: rgba(0,0,0,.08); margin: 1.8rem 0; }
    .post-body a{ color:#1e66ff; text-decoration: underline; text-underline-offset: 2px; }

    /* Center inline figures inside post body */
    .prose figure{
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 1.5rem auto;
      text-align: center;
    }
    .prose figure img{
      display: block;
      margin: 0 auto;
      max-width: 100%;
      height: auto;
    }
    .prose figure figcaption{
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #666;
      text-align: center;
    }

    @media (max-width: 640px){
      :root{ --side-bleed: 16px; }
    }
  </style>
</BaseLayout>
