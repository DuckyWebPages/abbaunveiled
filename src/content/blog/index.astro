---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

// Fetch posts (non-drafts) and sort newest first
const posts = await getCollection("blog", ({ data }) => !data.draft);
posts.sort((a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate));

// Helpers
function fmtDate(d: unknown) {
  if (!d) return "";
  const dt = d instanceof Date ? d : new Date(String(d));
  return isNaN(+dt) ? "" : dt.toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
}
function normTags(val: unknown): string[] {
  if (Array.isArray(val)) return val.filter(Boolean);
  if (typeof val === "string") return val.split(",").map(s => s.trim()).filter(Boolean);
  return [];
}
---

<BaseLayout title="Blog" description="Latest posts from Abba Unveiled">
  <section class="page-hero" aria-labelledby="blog-title">
    <h1 id="blog-title">Blog</h1>
    <p class="sub">Theological discussions about Abba Father - the Father Jesus revealed (Not Yahweh).</p>
  </section>

  <section class="grid" aria-label="Post grid">
    {posts.map((post) => {
      const href = `/blog/${post.slug}/`;
      const title = post.data.title ?? post.slug;
      const date = fmtDate(post.data.pubDate);
      const desc = post.data.excerpt ?? post.data.description ?? "";
      const tags = normTags(post.data.tags);
      // heroImage supports either image() object or string path
     const hero =
  post.data.cardImage?.src ?? post.data.cardImage ??
  post.data.heroImage?.src ?? post.data.heroImage ??
  null;


      return (
        <a class="card" href={href}>
          <figure class="thumb">
            {hero ? (
              <img src={hero} alt={title} loading="lazy" decoding="async" />
            ) : (
              <div class="thumb-fallback" aria-hidden="true">AU</div>
            )}
          </figure>

          <div class="card-body">
            <h2 class="card-title">{title}</h2>
            {date && <div class="meta">{date}</div>}
            {desc && <p class="excerpt">{desc}</p>}
            {tags.length > 0 && (
              <ul class="tags" aria-label="Tags">
                {tags.map((t) => <li class="tag" key={t}>{t}</li>)}
              </ul>
            )}
          </div>
        </a>
      );
    })}
  </section>

  <style>
    :root {
      --fg: #0b0b0c;
      --muted: #6a6a6d;
      --card: #ffffff;
      --bg: #f7f7f9;
      --line: #e9e9ee;
      --brand: #4b6bfb; /* soft indigo accent */
    }

    .page-hero {
      max-width: 68rem;
      margin: 2rem auto 1rem;
      padding: 0 1rem;
    }
    .page-hero h1 {
      font-size: clamp(2rem, 3vw, 2.75rem);
      line-height: 1.1;
      margin: 0 0 .25rem 0;
      color: var(--fg);
      letter-spacing: -0.01em;
    }
    .page-hero .sub {
      margin: 0;
      color: var(--muted);
      font-size: 1.05rem;
    }

    .grid {
      max-width: 68rem;
      margin: 1rem auto 3rem;
      padding: 0 1rem;
      display: grid;
      gap: 1.25rem;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .card {
      display: grid;
      grid-template-rows: auto 1fr;
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      overflow: hidden;
      text-decoration: none;
      color: inherit;
      transition: box-shadow .2s ease, transform .2s ease, border-color .2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      border-color: #dfe3f3;
    }

    .thumb {
      aspect-ratio: 16 / 9;
      background: var(--bg);
      margin: 0;
      overflow: hidden;
    }
    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
    .thumb-fallback {
      width: 100%;
      height: 100%;
      display: grid;
      place-items: center;
      font-weight: 700;
      letter-spacing: .08em;
      color: #c4c7d5;
      background: linear-gradient(135deg, #eef1ff, #f7f8ff);
      user-select: none;
    }

    .card-body {
      padding: 0.9rem 1rem 1.1rem;
      display: grid;
      gap: .45rem;
      align-content: start;
    }
    .card-title {
      font-size: 1.1rem;
      margin: 0;
      color: var(--fg);
      line-height: 1.25;
      letter-spacing: -0.005em;
    }
    .meta {
      font-size: .9rem;
      color: var(--muted);
    }
    .excerpt {
      margin: .25rem 0 0;
      color: #2a2a2e;
      font-size: .98rem;
      line-height: 1.45;
    }
    .tags {
      list-style: none;
      padding: 0;
      margin: .35rem 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: .4rem;
    }
    .tag {
      font-size: .78rem;
      color: #2d3a62;
      background: #eef2ff;
      border: 1px solid #dde4ff;
      padding: .22rem .5rem;
      border-radius: 999px;
      white-space: nowrap;
    }

    @media (hover: hover) {
      .card:hover .card-title { text-decoration: underline; }
    }
  </style>
</BaseLayout>
